<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathemagician Test UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .status.processing {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .video-container {
            margin-top: 15px;
            text-align: center;
        }

        video {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .job-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-tab {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        .examples {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .examples h4 {
            margin-bottom: 8px;
            font-size: 14px;
            color: #667eea;
        }

        .example-btn {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .example-btn:hover {
            background: #d0d0d0;
        }

        .settings {
            margin-bottom: 15px;
        }

        .api-url-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® Mathemagician Test UI</h1>
            <p class="subtitle">Test math visualizations and natural language editing</p>
        </header>

        <div class="settings panel">
            <label for="apiUrl">API URL:</label>
            <input type="text" id="apiUrl" class="api-url-input" value="http://localhost:8000"
                   placeholder="http://localhost:8000 or https://your-service.run.app">
        </div>

        <div class="main-content">
            <!-- Left Panel: Input -->
            <div class="panel">
                <h2>Generate Visualization ‚ú®</h2>

                <div class="form-group">
                    <label for="naturalPrompt">Describe what you want to visualize:</label>
                    <textarea id="naturalPrompt" rows="4" placeholder="Show me a sine wave from -5 to 5" autofocus>Show me a sine wave</textarea>
                </div>

                <div class="form-group">
                    <label for="videoLength">Video Length (seconds):</label>
                    <input type="number" id="videoLength" min="1" max="30" step="0.5" value="4" placeholder="4">
                    <small style="color: #666; display: block; margin-top: 3px;">Duration of the animation (1-30 seconds)</small>
                </div>

                <div class="examples">
                    <h4>Example Prompts:</h4>
                    <button class="example-btn" onclick="setNaturalExample('Show me a sine wave')">sine wave</button>
                    <button class="example-btn" onclick="setNaturalExample('Plot x squared from -3 to 3')">parabola</button>
                    <button class="example-btn" onclick="setNaturalExample('A red cosine wave')">red cosine</button>
                    <button class="example-btn" onclick="setNaturalExample('sine wave without axis labels')">no labels</button>
                    <button class="example-btn" onclick="setNaturalExample('sine wave with clean axes')">clean axes</button>
                    <button class="example-btn" onclick="setNaturalExample('Visualize sin(x) + cos(2x) from -6 to 6')">composite</button>
                </div>

                <button onclick="generateNatural()" id="generateBtn" class="primary-btn">Generate Visualization</button>
                <div class="status info" style="margin-top: 10px;">
                    <strong>Powered by Claude AI</strong> - Automatically interprets your description into mathematical visualizations
                </div>

                <!-- Edit Mode -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <h2>Edit Existing Visualization</h2>
                    <div class="form-group">
                        <label for="editJobId">Job ID to Edit:</label>
                        <input type="text" id="editJobId" placeholder="Paste job_id from previous generation">
                    </div>
                    <div class="form-group">
                        <label for="editPrompt">What to change:</label>
                        <textarea id="editPrompt" rows="3" placeholder="Make it blue and extend to x = 10"></textarea>
                    </div>
                    <div class="examples">
                        <h4>Example Edits:</h4>
                        <button class="example-btn" onclick="setEditExample('Make it red')">change color</button>
                        <button class="example-btn" onclick="setEditExample('Remove the axis labels')">hide labels</button>
                        <button class="example-btn" onclick="setEditExample('Extend the range to -10 to 10')">extend range</button>
                        <button class="example-btn" onclick="setEditExample('Change it to a cosine wave')">change function</button>
                    </div>
                    <button onclick="editVisualization()" id="editBtn">Edit Visualization</button>
                    <div class="status info" style="margin-top: 10px;">
                        <strong>Note:</strong> Requires ANTHROPIC_API_KEY to be set in .env file
                    </div>
                </div>
            </div>

            <!-- Right Panel: Output -->
            <div class="panel">
                <h2>Result</h2>

                <div id="statusContainer"></div>

                <div id="videoContainer" class="video-container" style="display: none;">
                    <video id="videoPlayer" controls></video>
                    <div id="jobInfo" class="job-info"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let pollingInterval = null;

        function getApiUrl() {
            return document.getElementById('apiUrl').value.trim().replace(/\/$/, '');
        }

        function switchMode(mode) {
            // Update tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.mode-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(mode + 'Mode').classList.add('active');
        }

        function setExample(func, xMin, xMax) {
            document.getElementById('function').value = func;
            document.getElementById('xMin').value = xMin;
            document.getElementById('xMax').value = xMax;
        }

        function setNaturalExample(prompt) {
            document.getElementById('naturalPrompt').value = prompt;
        }

        function setEditExample(editText) {
            document.getElementById('editPrompt').value = editText;
        }

        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function generateDirect() {
            const apiUrl = getApiUrl();
            const funcValue = document.getElementById('function').value.trim();
            const xMin = parseFloat(document.getElementById('xMin').value);
            const xMax = parseFloat(document.getElementById('xMax').value);
            const yMin = document.getElementById('yMin').value;
            const yMax = document.getElementById('yMax').value;

            if (!funcValue || isNaN(xMin) || isNaN(xMax)) {
                showStatus('Please fill in function and x range', 'error');
                return;
            }

            const payload = {
                function: funcValue,
                x_range: [xMin, xMax]
            };

            if (yMin && yMax) {
                payload.y_range = [parseFloat(yMin), parseFloat(yMax)];
            }

            document.getElementById('generateBtn').disabled = true;
            showStatus('Sending request... <span class="spinner"></span>', 'processing');

            try {
                const response = await fetch(`${apiUrl}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    currentJobId = data.job_id;
                    showStatus(`Job created! ID: ${data.job_id}<br>Status: ${data.status}`, 'success');
                    document.getElementById('editJobId').value = data.job_id;
                    startPolling(data.job_id);
                } else {
                    showStatus(`Error: ${data.detail || 'Unknown error'}`, 'error');
                    document.getElementById('generateBtn').disabled = false;
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                document.getElementById('generateBtn').disabled = false;
            }
        }

        async function generateNatural() {
            const apiUrl = getApiUrl();
            const description = document.getElementById('naturalPrompt').value.trim();
            const videoLength = parseFloat(document.getElementById('videoLength').value);

            if (!description) {
                showStatus('Please enter a description', 'error');
                return;
            }

            const payload = {
                description: description
            };

            // Add video_length if specified and valid
            if (videoLength && !isNaN(videoLength) && videoLength > 0) {
                payload.video_length = videoLength;
            }

            document.getElementById('generateBtn').disabled = true;
            showStatus('Interpreting description with Claude... <span class="spinner"></span>', 'processing');

            try {
                const response = await fetch(`${apiUrl}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    currentJobId = data.job_id;
                    showStatus(`Job created! ID: ${data.job_id}<br>Status: ${data.status}`, 'success');
                    document.getElementById('editJobId').value = data.job_id;
                    startPolling(data.job_id);
                } else {
                    showStatus(`Error: ${data.detail || 'Unknown error'}`, 'error');
                    document.getElementById('generateBtn').disabled = false;
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                document.getElementById('generateBtn').disabled = false;
            }
        }

        async function editVisualization() {
            const apiUrl = getApiUrl();
            const jobId = document.getElementById('editJobId').value.trim();
            const editDescription = document.getElementById('editPrompt').value.trim();

            if (!jobId || !editDescription) {
                showStatus('Please enter both job ID and edit description', 'error');
                return;
            }

            const payload = {
                job_id: jobId,
                edit_description: editDescription
            };

            document.getElementById('editBtn').disabled = true;
            showStatus('Applying edit with Claude... <span class="spinner"></span>', 'processing');

            try {
                const response = await fetch(`${apiUrl}/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    currentJobId = data.job_id;
                    showStatus(`Edit job created! New ID: ${data.job_id}<br>Status: ${data.status}`, 'success');
                    document.getElementById('editJobId').value = data.job_id;
                    startPolling(data.job_id);
                } else {
                    showStatus(`Error: ${data.detail || 'Unknown error'}`, 'error');
                    document.getElementById('editBtn').disabled = false;
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                document.getElementById('editBtn').disabled = false;
            }
        }

        async function startPolling(jobId) {
            const apiUrl = getApiUrl();

            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            let attempts = 0;
            const maxAttempts = 60;

            pollingInterval = setInterval(async () => {
                attempts++;

                try {
                    const response = await fetch(`${apiUrl}/status/${jobId}`);
                    const data = await response.json();

                    if (data.status === 'completed') {
                        clearInterval(pollingInterval);
                        showStatus('‚úÖ Rendering completed!', 'success');
                        displayVideo(data);
                        document.getElementById('generateBtn').disabled = false;
                        document.getElementById('editBtn').disabled = false;
                    } else if (data.status === 'failed') {
                        clearInterval(pollingInterval);
                        showStatus(`‚ùå Rendering failed: ${data.error || 'Unknown error'}`, 'error');
                        document.getElementById('generateBtn').disabled = false;
                        document.getElementById('editBtn').disabled = false;
                    } else {
                        showStatus(`Rendering... (${data.status}) <span class="spinner"></span>`, 'processing');
                    }

                    if (attempts >= maxAttempts) {
                        clearInterval(pollingInterval);
                        showStatus('Timeout waiting for completion', 'error');
                        document.getElementById('generateBtn').disabled = false;
                        document.getElementById('editBtn').disabled = false;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        function displayVideo(data) {
            const apiUrl = getApiUrl();
            const videoContainer = document.getElementById('videoContainer');
            const videoPlayer = document.getElementById('videoPlayer');
            const jobInfo = document.getElementById('jobInfo');

            // Construct full URL for video
            let videoUrl = data.video_url;
            if (videoUrl && !videoUrl.startsWith('http')) {
                videoUrl = apiUrl + videoUrl;
            }

            videoPlayer.src = videoUrl;
            videoContainer.style.display = 'block';

            jobInfo.innerHTML = `
                <strong>Job ID:</strong> ${data.job_id}<br>
                <strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}<br>
                <strong>Completed:</strong> ${new Date(data.completed_at).toLocaleString()}<br>
                <strong>Video:</strong> <a href="${videoUrl}" target="_blank">Open in new tab</a>
            `;
        }

        // Test connection on load
        window.addEventListener('load', async () => {
            const apiUrl = getApiUrl();
            try {
                console.log('Testing connection to:', apiUrl);
                const response = await fetch(`${apiUrl}/health`);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Connected to API:', data);
                showStatus(`‚úÖ Connected to API (${data.environment})`, 'success');
            } catch (error) {
                console.error('Connection error:', error);
                showStatus(`‚ö†Ô∏è Cannot connect to API at ${apiUrl}. Check console for details.<br>Make sure Docker is running: <code>docker-compose up</code>`, 'error');
            }
        });
    </script>
</body>
</html>
